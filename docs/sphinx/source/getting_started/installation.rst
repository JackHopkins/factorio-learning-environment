Installation
============

Prerequisites
-------------

- Docker
- Python 3.10+
- Factorio (version 1.1.110), only for optional rendering

Installation
------------

Core FLE SDK package
^^^^^^^^^^^^^^^^^^^^

.. code-block:: bash

   # Core FLE SDK package
   pip install factorio-learning-environment
   uv add factorio-learning-environment

With optional features
^^^^^^^^^^^^^^^^^^^^^^

.. code-block:: bash

   # With optional features
   pip install factorio-learning-environment[eval]      # For running experiments
   pip install factorio-learning-environment[mcp]       # For MCP protocol support  
   pip install factorio-learning-environment[psql]      # For PostgreSQL support
   pip install factorio-learning-environment[eval,mcp,psql]  # All features

   # Using uv (recommended)
   uv add factorio-learning-environment[eval]

Quickstart
^^^^^^^^^^

1. **Clone the repository**:

.. code-block:: bash

   # Start Factorio cluster
   fle cluster start

   # Run evaluation trajectories (requires [eval] dependencies)
   fle eval --config configs/gym_run_config.json

Or import the package in your Python code:

.. code-block:: python

   # Core SDK usage
   from fle.env import FactorioInstance
   instance = FactorioInstance()

   # Evaluation features (requires [eval] dependencies)
   from fle.agents.gym_agent import GymAgent

.. note::
   When you run ``fle init`` or ``fle eval`` for the first time, an ``.env`` file and a ``configs/`` directory with example configurations are created automatically

Gym Environment Usage
^^^^^^^^^^^^^^^^^^^^^

.. code-block:: bash

   # Run Factorio servers
   fle cluster start # Starts 1 instance with default lab scenario

   # Alternatively:
   fle cluster start -n 4                     # Start 4 instances  
   fle cluster start -s open_world            # Start with open world scenario

Configure Database
^^^^^^^^^^^^^^^^^^

Copy the example environment file:

.. code-block:: bash

   cp .example.env .env

.. note::
   API keys are only required for the respective model providers that will be evaluated

Run Evaluation
^^^^^^^^^^^^^^

Running open and lab play with example run configs:

.. code-block:: bash

   # Using uv
   uv run -m fle.run --run_config=fle/eval/algorithms/independent/gym_run_config.json
   # Using python
   python -m fle.run --run_config=fle/eval/algorithms/independent/gym_run_config.json

Client-side running (optional, renders graphics)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

1. **Set up Factorio client**:
   - Purchase Factorio from the `official website <https://www.factorio.com/>`_ (recommended) or on Steam.
   - Downgrade to version 1.1.110:
     - Steam: Right-click Factorio → Properties → Betas → Select 1.1.110
     - **Important**: Make sure to uncheck the Space Age DLC if you have it, as it forces the 2.x branch

2. **Activate server**:
   - Open Factorio client
   - Navigate to *Multiplayer*
   - Connect to ``localhost:34197`` (default) or your configured address in Docker.
     - Once connected, you can safely disconnect. This step confirms your Factorio license with the server.

API Key Configuration
^^^^^^^^^^^^^^^^^^^^^

FLE supports multiple LLM providers for agent evaluation. To get started with API keys:

1. **Quick Setup** (Recommended):
   .. code-block:: bash

      python fle/eval/infra/setup_api_keys.py

   This interactive script helps you:
   - Configure API keys for OpenAI, Anthropic, and other providers
   - Set up API key rotation for high-volume experiments
   - Generate provider-specific configuration files
   - Validate your API key setup

2. **Manual Setup**:
   Add your API keys to the ``.env`` file:
   .. code-block:: bash

      # OpenAI
      OPENAI_API_KEY=sk-...

      # Anthropic
      ANTHROPIC_API_KEY=sk-ant-...

      # Additional providers as needed

3. **Advanced Configuration**:
   For large-scale experiments, you can set up API key rotation and provider-specific settings using the configuration files generated by ``setup_api_keys.py``.

Troubleshooting
^^^^^^^^^^^^^^^

- **"No valid programs found for version X"**: This is normal during initialization. The system will start generating programs shortly.
- **Database connection errors**: Verify your database configuration in the .env file and ensure the database exists.
- **API key errors**: Run ``python fle/eval/infra/setup_api_keys.py`` to verify your API key configuration.
- **Docker issues**: Ensure your user has permission to run Docker without sudo.
- **Connection issues**: Make sure the Factorio server is running and ports are properly configured.
