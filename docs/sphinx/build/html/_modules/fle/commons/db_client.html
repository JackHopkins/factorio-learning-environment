

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fle.commons.db_client &mdash; Factorio Learning Environment 0.3.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=e259d695"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Factorio Learning Environment
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/installation.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/installation.html#id1">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/installation.html#core-fle-sdk-package">Core FLE SDK package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/installation.html#with-optional-features">With optional features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/installation.html#quickstart">Quickstart</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/installation.html#gym-environment-usage">Gym Environment Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/installation.html#configure-database">Configure Database</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/installation.html#run-evaluation">Run Evaluation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/installation.html#client-side-running-optional-renders-graphics">Client-side running (optional, renders graphics)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/installation.html#api-key-configuration">API Key Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/installation.html#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/quickstart.html">First Agent in FLE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/quickstart.html#basic-observation-and-action-spaces">Basic Observation and Action Spaces</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#basic-example">Basic Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/quickstart.html#gym-environment-usage">Gym Environment Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#list-available-environments">List Available Environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#create-an-environment">Create an Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#use-the-environment">Use the Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#available-environments">Available Environments</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../getting_started/quickstart.html#throughput-tasks-lab-play">Throughput Tasks (Lab Play)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../getting_started/quickstart.html#example-usage">Example Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#environment-interface">Environment Interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../getting_started/quickstart.html#action-space">Action Space</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../getting_started/quickstart.html#observation-space">Observation Space</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../getting_started/quickstart.html#methods">Methods</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/quickstart.html#complete-example">Complete Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/cluster.html">Cluster Setup and Management</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/cluster.html#starting-a-cluster">Starting a Cluster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/cluster.html#basic-usage">Basic Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/cluster.html#advanced-configuration">Advanced Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/cluster.html#cluster-management">Cluster Management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/cluster.html#listing-running-instances">Listing Running Instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/cluster.html#stopping-the-cluster">Stopping the Cluster</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/cluster.html#scenarios">Scenarios</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/cluster.html#lab-play-scenario">Lab Play Scenario</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/cluster.html#open-world-scenario">Open World Scenario</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting_started/cluster.html#custom-scenarios">Custom Scenarios</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Core API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/environment.html">Environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/environment.html#repl-pattern-example">REPL Pattern Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/environment.html#observation-streams">Observation Streams</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/environment.html#agent-enhancement">Agent Enhancement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/environment.html#factorioinstance">FactorioInstance</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance"><code class="docutils literal notranslate"><span class="pre">FactorioInstance</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.namespace_class"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.namespace_class</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.__init__"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.namespace"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.namespace</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.first_namespace"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.first_namespace</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.is_multiagent"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.is_multiagent</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.reset"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.reset()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.set_speed"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.set_speed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.get_speed"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.get_speed()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.get_elapsed_ticks"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.get_elapsed_ticks()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.pause"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.pause()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.unpause"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.unpause()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.set_speed_and_unpause"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.set_speed_and_unpause()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.get_system_prompt"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.get_system_prompt()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.connect_to_server"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.connect_to_server()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.eval_with_error"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.eval_with_error()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.eval"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.eval()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.initialise"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.initialise()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.get_warnings"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.get_warnings()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.instance.FactorioInstance.cleanup"><code class="docutils literal notranslate"><span class="pre">FactorioInstance.cleanup()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/environment.html#namespace-management">Namespace Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/environment.html#entity-types">Entity Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity"><code class="docutils literal notranslate"><span class="pre">Entity</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.id"><code class="docutils literal notranslate"><span class="pre">Entity.id</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.energy"><code class="docutils literal notranslate"><span class="pre">Entity.energy</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.type"><code class="docutils literal notranslate"><span class="pre">Entity.type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.dimensions"><code class="docutils literal notranslate"><span class="pre">Entity.dimensions</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.tile_dimensions"><code class="docutils literal notranslate"><span class="pre">Entity.tile_dimensions</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.prototype"><code class="docutils literal notranslate"><span class="pre">Entity.prototype</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.health"><code class="docutils literal notranslate"><span class="pre">Entity.health</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.warnings"><code class="docutils literal notranslate"><span class="pre">Entity.warnings</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.status"><code class="docutils literal notranslate"><span class="pre">Entity.status</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.width"><code class="docutils literal notranslate"><span class="pre">Entity.width</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.height"><code class="docutils literal notranslate"><span class="pre">Entity.height</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Entity.model_config"><code class="docutils literal notranslate"><span class="pre">Entity.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Inventory"><code class="docutils literal notranslate"><span class="pre">Inventory</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Inventory.model_config"><code class="docutils literal notranslate"><span class="pre">Inventory.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Inventory.get"><code class="docutils literal notranslate"><span class="pre">Inventory.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Inventory.items"><code class="docutils literal notranslate"><span class="pre">Inventory.items()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Inventory.keys"><code class="docutils literal notranslate"><span class="pre">Inventory.keys()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Inventory.values"><code class="docutils literal notranslate"><span class="pre">Inventory.values()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Inventory.serialize_model"><code class="docutils literal notranslate"><span class="pre">Inventory.serialize_model()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position"><code class="docutils literal notranslate"><span class="pre">Position</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.x"><code class="docutils literal notranslate"><span class="pre">Position.x</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.y"><code class="docutils literal notranslate"><span class="pre">Position.y</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.__init__"><code class="docutils literal notranslate"><span class="pre">Position.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.parse_args"><code class="docutils literal notranslate"><span class="pre">Position.parse_args()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.is_close"><code class="docutils literal notranslate"><span class="pre">Position.is_close()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.distance"><code class="docutils literal notranslate"><span class="pre">Position.distance()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.above"><code class="docutils literal notranslate"><span class="pre">Position.above()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.up"><code class="docutils literal notranslate"><span class="pre">Position.up()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.below"><code class="docutils literal notranslate"><span class="pre">Position.below()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.down"><code class="docutils literal notranslate"><span class="pre">Position.down()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.left"><code class="docutils literal notranslate"><span class="pre">Position.left()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.right"><code class="docutils literal notranslate"><span class="pre">Position.right()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.to_bounding_box"><code class="docutils literal notranslate"><span class="pre">Position.to_bounding_box()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.entities.Position.model_config"><code class="docutils literal notranslate"><span class="pre">Position.model_config</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/environment.html#game-types">Game Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype"><code class="docutils literal notranslate"><span class="pre">Prototype</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.AssemblingMachine1"><code class="docutils literal notranslate"><span class="pre">Prototype.AssemblingMachine1</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.AssemblingMachine2"><code class="docutils literal notranslate"><span class="pre">Prototype.AssemblingMachine2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.AssemblingMachine3"><code class="docutils literal notranslate"><span class="pre">Prototype.AssemblingMachine3</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Centrifuge"><code class="docutils literal notranslate"><span class="pre">Prototype.Centrifuge</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.BurnerInserter"><code class="docutils literal notranslate"><span class="pre">Prototype.BurnerInserter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.FastInserter"><code class="docutils literal notranslate"><span class="pre">Prototype.FastInserter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ExpressInserter"><code class="docutils literal notranslate"><span class="pre">Prototype.ExpressInserter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.LongHandedInserter"><code class="docutils literal notranslate"><span class="pre">Prototype.LongHandedInserter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.StackInserter"><code class="docutils literal notranslate"><span class="pre">Prototype.StackInserter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.StackFilterInserter"><code class="docutils literal notranslate"><span class="pre">Prototype.StackFilterInserter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.FilterInserter"><code class="docutils literal notranslate"><span class="pre">Prototype.FilterInserter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Inserter"><code class="docutils literal notranslate"><span class="pre">Prototype.Inserter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.BurnerMiningDrill"><code class="docutils literal notranslate"><span class="pre">Prototype.BurnerMiningDrill</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ElectricMiningDrill"><code class="docutils literal notranslate"><span class="pre">Prototype.ElectricMiningDrill</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.StoneFurnace"><code class="docutils literal notranslate"><span class="pre">Prototype.StoneFurnace</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.SteelFurnace"><code class="docutils literal notranslate"><span class="pre">Prototype.SteelFurnace</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ElectricFurnace"><code class="docutils literal notranslate"><span class="pre">Prototype.ElectricFurnace</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Splitter"><code class="docutils literal notranslate"><span class="pre">Prototype.Splitter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.FastSplitter"><code class="docutils literal notranslate"><span class="pre">Prototype.FastSplitter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ExpressSplitter"><code class="docutils literal notranslate"><span class="pre">Prototype.ExpressSplitter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Rail"><code class="docutils literal notranslate"><span class="pre">Prototype.Rail</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.TransportBelt"><code class="docutils literal notranslate"><span class="pre">Prototype.TransportBelt</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.FastTransportBelt"><code class="docutils literal notranslate"><span class="pre">Prototype.FastTransportBelt</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ExpressTransportBelt"><code class="docutils literal notranslate"><span class="pre">Prototype.ExpressTransportBelt</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ExpressUndergroundBelt"><code class="docutils literal notranslate"><span class="pre">Prototype.ExpressUndergroundBelt</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.FastUndergroundBelt"><code class="docutils literal notranslate"><span class="pre">Prototype.FastUndergroundBelt</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.UndergroundBelt"><code class="docutils literal notranslate"><span class="pre">Prototype.UndergroundBelt</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.OffshorePump"><code class="docutils literal notranslate"><span class="pre">Prototype.OffshorePump</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.PumpJack"><code class="docutils literal notranslate"><span class="pre">Prototype.PumpJack</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Pump"><code class="docutils literal notranslate"><span class="pre">Prototype.Pump</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Boiler"><code class="docutils literal notranslate"><span class="pre">Prototype.Boiler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.OilRefinery"><code class="docutils literal notranslate"><span class="pre">Prototype.OilRefinery</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ChemicalPlant"><code class="docutils literal notranslate"><span class="pre">Prototype.ChemicalPlant</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.SteamEngine"><code class="docutils literal notranslate"><span class="pre">Prototype.SteamEngine</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.SolarPanel"><code class="docutils literal notranslate"><span class="pre">Prototype.SolarPanel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.UndergroundPipe"><code class="docutils literal notranslate"><span class="pre">Prototype.UndergroundPipe</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.HeatPipe"><code class="docutils literal notranslate"><span class="pre">Prototype.HeatPipe</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Pipe"><code class="docutils literal notranslate"><span class="pre">Prototype.Pipe</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.SteelChest"><code class="docutils literal notranslate"><span class="pre">Prototype.SteelChest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.IronChest"><code class="docutils literal notranslate"><span class="pre">Prototype.IronChest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.WoodenChest"><code class="docutils literal notranslate"><span class="pre">Prototype.WoodenChest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.IronGearWheel"><code class="docutils literal notranslate"><span class="pre">Prototype.IronGearWheel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.StorageTank"><code class="docutils literal notranslate"><span class="pre">Prototype.StorageTank</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.SmallElectricPole"><code class="docutils literal notranslate"><span class="pre">Prototype.SmallElectricPole</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.MediumElectricPole"><code class="docutils literal notranslate"><span class="pre">Prototype.MediumElectricPole</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.BigElectricPole"><code class="docutils literal notranslate"><span class="pre">Prototype.BigElectricPole</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Coal"><code class="docutils literal notranslate"><span class="pre">Prototype.Coal</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Wood"><code class="docutils literal notranslate"><span class="pre">Prototype.Wood</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Sulfur"><code class="docutils literal notranslate"><span class="pre">Prototype.Sulfur</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.IronOre"><code class="docutils literal notranslate"><span class="pre">Prototype.IronOre</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.CopperOre"><code class="docutils literal notranslate"><span class="pre">Prototype.CopperOre</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Stone"><code class="docutils literal notranslate"><span class="pre">Prototype.Stone</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Concrete"><code class="docutils literal notranslate"><span class="pre">Prototype.Concrete</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.UraniumOre"><code class="docutils literal notranslate"><span class="pre">Prototype.UraniumOre</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.IronPlate"><code class="docutils literal notranslate"><span class="pre">Prototype.IronPlate</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.IronStick"><code class="docutils literal notranslate"><span class="pre">Prototype.IronStick</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.SteelPlate"><code class="docutils literal notranslate"><span class="pre">Prototype.SteelPlate</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.CopperPlate"><code class="docutils literal notranslate"><span class="pre">Prototype.CopperPlate</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.StoneBrick"><code class="docutils literal notranslate"><span class="pre">Prototype.StoneBrick</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.CopperCable"><code class="docutils literal notranslate"><span class="pre">Prototype.CopperCable</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.PlasticBar"><code class="docutils literal notranslate"><span class="pre">Prototype.PlasticBar</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.EmptyBarrel"><code class="docutils literal notranslate"><span class="pre">Prototype.EmptyBarrel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Battery"><code class="docutils literal notranslate"><span class="pre">Prototype.Battery</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.SulfuricAcid"><code class="docutils literal notranslate"><span class="pre">Prototype.SulfuricAcid</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Uranium235"><code class="docutils literal notranslate"><span class="pre">Prototype.Uranium235</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Uranium238"><code class="docutils literal notranslate"><span class="pre">Prototype.Uranium238</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Lubricant"><code class="docutils literal notranslate"><span class="pre">Prototype.Lubricant</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.PetroleumGas"><code class="docutils literal notranslate"><span class="pre">Prototype.PetroleumGas</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.AdvancedOilProcessing"><code class="docutils literal notranslate"><span class="pre">Prototype.AdvancedOilProcessing</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.CoalLiquifaction"><code class="docutils literal notranslate"><span class="pre">Prototype.CoalLiquifaction</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.SolidFuel"><code class="docutils literal notranslate"><span class="pre">Prototype.SolidFuel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.LightOil"><code class="docutils literal notranslate"><span class="pre">Prototype.LightOil</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.HeavyOil"><code class="docutils literal notranslate"><span class="pre">Prototype.HeavyOil</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ElectronicCircuit"><code class="docutils literal notranslate"><span class="pre">Prototype.ElectronicCircuit</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.AdvancedCircuit"><code class="docutils literal notranslate"><span class="pre">Prototype.AdvancedCircuit</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ProcessingUnit"><code class="docutils literal notranslate"><span class="pre">Prototype.ProcessingUnit</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.EngineUnit"><code class="docutils literal notranslate"><span class="pre">Prototype.EngineUnit</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ElectricEngineUnit"><code class="docutils literal notranslate"><span class="pre">Prototype.ElectricEngineUnit</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Lab"><code class="docutils literal notranslate"><span class="pre">Prototype.Lab</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Accumulator"><code class="docutils literal notranslate"><span class="pre">Prototype.Accumulator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.GunTurret"><code class="docutils literal notranslate"><span class="pre">Prototype.GunTurret</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.PiercingRoundsMagazine"><code class="docutils literal notranslate"><span class="pre">Prototype.PiercingRoundsMagazine</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.FirearmMagazine"><code class="docutils literal notranslate"><span class="pre">Prototype.FirearmMagazine</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Grenade"><code class="docutils literal notranslate"><span class="pre">Prototype.Grenade</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Radar"><code class="docutils literal notranslate"><span class="pre">Prototype.Radar</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.StoneWall"><code class="docutils literal notranslate"><span class="pre">Prototype.StoneWall</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Gate"><code class="docutils literal notranslate"><span class="pre">Prototype.Gate</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.SmallLamp"><code class="docutils literal notranslate"><span class="pre">Prototype.SmallLamp</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.NuclearReactor"><code class="docutils literal notranslate"><span class="pre">Prototype.NuclearReactor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.UraniumFuelCell"><code class="docutils literal notranslate"><span class="pre">Prototype.UraniumFuelCell</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.HeatExchanger"><code class="docutils literal notranslate"><span class="pre">Prototype.HeatExchanger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.AutomationSciencePack"><code class="docutils literal notranslate"><span class="pre">Prototype.AutomationSciencePack</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.MilitarySciencePack"><code class="docutils literal notranslate"><span class="pre">Prototype.MilitarySciencePack</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.LogisticsSciencePack"><code class="docutils literal notranslate"><span class="pre">Prototype.LogisticsSciencePack</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ProductionSciencePack"><code class="docutils literal notranslate"><span class="pre">Prototype.ProductionSciencePack</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.UtilitySciencePack"><code class="docutils literal notranslate"><span class="pre">Prototype.UtilitySciencePack</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ChemicalSciencePack"><code class="docutils literal notranslate"><span class="pre">Prototype.ChemicalSciencePack</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ProductivityModule"><code class="docutils literal notranslate"><span class="pre">Prototype.ProductivityModule</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ProductivityModule2"><code class="docutils literal notranslate"><span class="pre">Prototype.ProductivityModule2</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ProductivityModule3"><code class="docutils literal notranslate"><span class="pre">Prototype.ProductivityModule3</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.FlyingRobotFrame"><code class="docutils literal notranslate"><span class="pre">Prototype.FlyingRobotFrame</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.RocketSilo"><code class="docutils literal notranslate"><span class="pre">Prototype.RocketSilo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Rocket"><code class="docutils literal notranslate"><span class="pre">Prototype.Rocket</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.Satellite"><code class="docutils literal notranslate"><span class="pre">Prototype.Satellite</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.RocketPart"><code class="docutils literal notranslate"><span class="pre">Prototype.RocketPart</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.RocketControlUnit"><code class="docutils literal notranslate"><span class="pre">Prototype.RocketControlUnit</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.LowDensityStructure"><code class="docutils literal notranslate"><span class="pre">Prototype.LowDensityStructure</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.RocketFuel"><code class="docutils literal notranslate"><span class="pre">Prototype.RocketFuel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.SpaceSciencePack"><code class="docutils literal notranslate"><span class="pre">Prototype.SpaceSciencePack</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.BeltGroup"><code class="docutils literal notranslate"><span class="pre">Prototype.BeltGroup</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.PipeGroup"><code class="docutils literal notranslate"><span class="pre">Prototype.PipeGroup</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.ElectricityGroup"><code class="docutils literal notranslate"><span class="pre">Prototype.ElectricityGroup</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.__init__"><code class="docutils literal notranslate"><span class="pre">Prototype.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.WIDTH"><code class="docutils literal notranslate"><span class="pre">Prototype.WIDTH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Prototype.HEIGHT"><code class="docutils literal notranslate"><span class="pre">Prototype.HEIGHT</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Resource"><code class="docutils literal notranslate"><span class="pre">Resource</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Resource.Coal"><code class="docutils literal notranslate"><span class="pre">Resource.Coal</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Resource.IronOre"><code class="docutils literal notranslate"><span class="pre">Resource.IronOre</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Resource.CopperOre"><code class="docutils literal notranslate"><span class="pre">Resource.CopperOre</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Resource.Stone"><code class="docutils literal notranslate"><span class="pre">Resource.Stone</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Resource.Water"><code class="docutils literal notranslate"><span class="pre">Resource.Water</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Resource.CrudeOil"><code class="docutils literal notranslate"><span class="pre">Resource.CrudeOil</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Resource.UraniumOre"><code class="docutils literal notranslate"><span class="pre">Resource.UraniumOre</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/environment.html#fle.env.game_types.Resource.Wood"><code class="docutils literal notranslate"><span class="pre">Resource.Wood</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/observation.html">Observation Space</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/observation.html#observation-components">Observation Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#raw-text-output">Raw Text Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#entities">Entities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#inventory">Inventory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#research">Research</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#game-info">Game Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#score">Score</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#flows">Flows</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#task-verification">Task Verification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#messages">Messages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#serialized-functions">Serialized Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#task-info">Task Info</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/observation.html#map-image">Map Image</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/observation.html#observation-space-structure">Observation Space Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/observation.html#using-observations">Using Observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/observation.html#example-observation-usage">Example Observation Usage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/action.html">Action Space</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/action.html#action-structure">Action Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/action.html#agent-index">Agent Index</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/action.html#game-state">Game State</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/action.html#code-synthesis">Code Synthesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/action.html#code-execution-environment">Code Execution Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/action.html#example-actions">Example Actions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/action.html#basic-movement">Basic Movement</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/action.html#entity-placement">Entity Placement</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/action.html#complex-automation">Complex Automation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/action.html#state-management">State Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/action.html#multi-agent-coordination">Multi-Agent Coordination</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/action.html#action-validation">Action Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/action.html#error-handling">Error Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/action.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/action.html#action-space-limitations">Action Space Limitations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/tools.html">Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/tools.html#anatomy-of-a-tool">Anatomy of a Tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/tools.html#core-tools">Core Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#inventory-management">Inventory Management</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#entity-management">Entity Management</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#resource-management">Resource Management</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#connection-management">Connection Management</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#production-management">Production Management</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#research-management">Research Management</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#movement-and-navigation">Movement and Navigation</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#utility-tools">Utility Tools</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#communication-tools">Communication Tools</a><ul class="simple">
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/tools.html#tool-categories-overview">Tool Categories Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/tools.html#creating-custom-tools">Creating Custom Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/tools.html#tool-usage-patterns">Tool Usage Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#basic-usage">Basic Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#error-handling">Error Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/tools.html#state-management">State Management</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/tools.html#best-practices">Best Practices</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Customization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../customization/tasks.html">Creating Custom Tasks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tasks.html#task-structure">Task Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tasks.html#required-methods">Required Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tasks.html#setup-instance-factorioinstance-none">setup(instance: FactorioInstance) -&gt; None</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tasks.html#verify-score-float-step-int-instance-factorioinstance-step-statistics-dict-bool">verify(score: float, step: int, instance: FactorioInstance, step_statistics: Dict) -&gt; bool</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tasks.html#task-components">Task Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tasks.html#initial-conditions">Initial Conditions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tasks.html#success-criteria">Success Criteria</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tasks.html#time-limits">Time Limits</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tasks.html#resource-constraints">Resource Constraints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tasks.html#scoring-mechanism">Scoring Mechanism</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tasks.html#task-examples">Task Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tasks.html#simple-production-task">Simple Production Task</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tasks.html#complex-automation-task">Complex Automation Task</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tasks.html#task-registration">Task Registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tasks.html#testing-tasks">Testing Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tasks.html#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../customization/tools.html">Creating Custom Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tools.html#tool-structure">Tool Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tools.html#creating-a-new-tool">Creating a New Tool</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tools.html#step-1-create-tool-directory">Step 1: Create Tool Directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tools.html#step-2-create-client-implementation">Step 2: Create Client Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tools.html#step-3-create-server-implementation">Step 3: Create Server Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tools.html#step-4-create-agent-documentation">Step 4: Create Agent Documentation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tools.html#tool-implementation-patterns">Tool Implementation Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tools.html#entity-manipulation-tools">Entity Manipulation Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tools.html#information-gathering-tools">Information Gathering Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/tools.html#resource-management-tools">Resource Management Tools</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tools.html#tool-testing">Tool Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tools.html#tool-registration">Tool Registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/tools.html#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../customization/agents.html">Implementing Custom Agents</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/agents.html#agent-structure">Agent Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/agents.html#required-methods">Required Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/agents.html#step-conversation-conversation-response-response-policy">step(conversation: Conversation, response: Response) -&gt; Policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/agents.html#end-conversation-conversation-completion-completionstate-none">end(conversation: Conversation, completion: CompletionState) -&gt; None</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/agents.html#agent-types">Agent Types</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/agents.html#basic-agent">Basic Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/agents.html#llm-based-agent">LLM-Based Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/agents.html#visual-agent">Visual Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/agents.html#multi-agent-coordination">Multi-Agent Coordination</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/agents.html#agent-configuration">Agent Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/agents.html#configuration-options">Configuration Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/agents.html#state-management">State Management</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/agents.html#error-handling">Error Handling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/agents.html#robust-error-handling">Robust Error Handling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/agents.html#agent-testing">Agent Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/agents.html#unit-tests">Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../customization/agents.html#integration-tests">Integration Tests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../customization/agents.html#best-practices">Best Practices</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/basic_agent.html">Basic Agent Example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/basic_agent.html#agent-implementation">Agent Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/basic_agent.html#running-the-agent">Running the Agent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/basic_agent.html#environment-setup">Environment Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/basic_agent.html#agent-execution-loop">Agent Execution Loop</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/basic_agent.html#expected-output">Expected Output</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/basic_agent.html#example-output">Example Output</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/basic_agent.html#agent-variations">Agent Variations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/basic_agent.html#random-action-agent">Random Action Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/basic_agent.html#stateful-agent">Stateful Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/basic_agent.html#error-handling-agent">Error Handling Agent</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/basic_agent.html#testing-the-agent">Testing the Agent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/basic_agent.html#unit-tests">Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/basic_agent.html#integration-tests">Integration Tests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/basic_agent.html#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/visual_agent.html">Visual Agent Example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/visual_agent.html#agent-implementation">Agent Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/visual_agent.html#vision-model-integration">Vision Model Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/visual_agent.html#openai-vision-model">OpenAI Vision Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/visual_agent.html#custom-vision-model">Custom Vision Model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/visual_agent.html#visual-processing-pipeline">Visual Processing Pipeline</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/visual_agent.html#image-preprocessing">Image Preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/visual_agent.html#multi-modal-analysis">Multi-Modal Analysis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/visual_agent.html#running-the-visual-agent">Running the Visual Agent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/visual_agent.html#environment-setup">Environment Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/visual_agent.html#agent-execution-loop">Agent Execution Loop</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/visual_agent.html#expected-output">Expected Output</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/visual_agent.html#example-output">Example Output</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/visual_agent.html#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/multiagent.html">Multi-Agent Coordination Example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/multiagent.html#agent-implementation">Agent Implementation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multiagent.html#coordinating-agent">Coordinating Agent</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/multiagent.html#specialized-agents">Specialized Agents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multiagent.html#mining-agent">Mining Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multiagent.html#building-agent">Building Agent</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/multiagent.html#running-multi-agent-system">Running Multi-Agent System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multiagent.html#environment-setup">Environment Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multiagent.html#multi-agent-execution-loop">Multi-Agent Execution Loop</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/multiagent.html#expected-output">Expected Output</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multiagent.html#example-output">Example Output</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/multiagent.html#best-practices">Best Practices</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Package API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">Package API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/modules.html#environment-module">Environment Module</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/modules.html#agents-module">Agents Module</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/modules.html#evaluation-module">Evaluation Module</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/modules.html#commons-module">Commons Module</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/modules.html#cluster-module">Cluster Module</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/modules.html#auto-generated-api-documentation">Auto-generated API Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/modules.html#module-fle.env.instance">Environment Core</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.instance.GameControl"><code class="docutils literal notranslate"><span class="pre">GameControl</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.instance.DirectionInternal"><code class="docutils literal notranslate"><span class="pre">DirectionInternal</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.instance.FactorioInstance"><code class="docutils literal notranslate"><span class="pre">FactorioInstance</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.namespace.LoopContext"><code class="docutils literal notranslate"><span class="pre">LoopContext</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.namespace.FactorioNamespace"><code class="docutils literal notranslate"><span class="pre">FactorioNamespace</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.namespace.wrap_for_serialization"><code class="docutils literal notranslate"><span class="pre">wrap_for_serialization()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.namespace.unwrap_after_deserialization"><code class="docutils literal notranslate"><span class="pre">unwrap_after_deserialization()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Layer"><code class="docutils literal notranslate"><span class="pre">Layer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.EntityStatus"><code class="docutils literal notranslate"><span class="pre">EntityStatus</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Inventory"><code class="docutils literal notranslate"><span class="pre">Inventory</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Direction"><code class="docutils literal notranslate"><span class="pre">Direction</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Position"><code class="docutils literal notranslate"><span class="pre">Position</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.IndexedPosition"><code class="docutils literal notranslate"><span class="pre">IndexedPosition</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.EntityInfo"><code class="docutils literal notranslate"><span class="pre">EntityInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.InspectionResults"><code class="docutils literal notranslate"><span class="pre">InspectionResults</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.BoundingBox"><code class="docutils literal notranslate"><span class="pre">BoundingBox</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.BuildingBox"><code class="docutils literal notranslate"><span class="pre">BuildingBox</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.ResourcePatch"><code class="docutils literal notranslate"><span class="pre">ResourcePatch</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Dimensions"><code class="docutils literal notranslate"><span class="pre">Dimensions</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.TileDimensions"><code class="docutils literal notranslate"><span class="pre">TileDimensions</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Ingredient"><code class="docutils literal notranslate"><span class="pre">Ingredient</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Product"><code class="docutils literal notranslate"><span class="pre">Product</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Recipe"><code class="docutils literal notranslate"><span class="pre">Recipe</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.BurnerType"><code class="docutils literal notranslate"><span class="pre">BurnerType</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.EntityCore"><code class="docutils literal notranslate"><span class="pre">EntityCore</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Entity"><code class="docutils literal notranslate"><span class="pre">Entity</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.StaticEntity"><code class="docutils literal notranslate"><span class="pre">StaticEntity</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Rail"><code class="docutils literal notranslate"><span class="pre">Rail</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Splitter"><code class="docutils literal notranslate"><span class="pre">Splitter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.TransportBelt"><code class="docutils literal notranslate"><span class="pre">TransportBelt</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Electric"><code class="docutils literal notranslate"><span class="pre">Electric</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.ElectricalProducer"><code class="docutils literal notranslate"><span class="pre">ElectricalProducer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.EnergySource"><code class="docutils literal notranslate"><span class="pre">EnergySource</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Accumulator"><code class="docutils literal notranslate"><span class="pre">Accumulator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Inserter"><code class="docutils literal notranslate"><span class="pre">Inserter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Filtered"><code class="docutils literal notranslate"><span class="pre">Filtered</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.UndergroundBelt"><code class="docutils literal notranslate"><span class="pre">UndergroundBelt</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.MiningDrill"><code class="docutils literal notranslate"><span class="pre">MiningDrill</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.ElectricMiningDrill"><code class="docutils literal notranslate"><span class="pre">ElectricMiningDrill</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.BurnerInserter"><code class="docutils literal notranslate"><span class="pre">BurnerInserter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.BurnerMiningDrill"><code class="docutils literal notranslate"><span class="pre">BurnerMiningDrill</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Ammo"><code class="docutils literal notranslate"><span class="pre">Ammo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.GunTurret"><code class="docutils literal notranslate"><span class="pre">GunTurret</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.AssemblingMachine"><code class="docutils literal notranslate"><span class="pre">AssemblingMachine</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.FluidHandler"><code class="docutils literal notranslate"><span class="pre">FluidHandler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.AdvancedAssemblingMachine"><code class="docutils literal notranslate"><span class="pre">AdvancedAssemblingMachine</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.MultiFluidHandler"><code class="docutils literal notranslate"><span class="pre">MultiFluidHandler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.FilterInserter"><code class="docutils literal notranslate"><span class="pre">FilterInserter</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.ChemicalPlant"><code class="docutils literal notranslate"><span class="pre">ChemicalPlant</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.OilRefinery"><code class="docutils literal notranslate"><span class="pre">OilRefinery</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.PumpJack"><code class="docutils literal notranslate"><span class="pre">PumpJack</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.SolarPanel"><code class="docutils literal notranslate"><span class="pre">SolarPanel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Boiler"><code class="docutils literal notranslate"><span class="pre">Boiler</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.HeatExchanger"><code class="docutils literal notranslate"><span class="pre">HeatExchanger</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Generator"><code class="docutils literal notranslate"><span class="pre">Generator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Pump"><code class="docutils literal notranslate"><span class="pre">Pump</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.OffshorePump"><code class="docutils literal notranslate"><span class="pre">OffshorePump</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.ElectricityPole"><code class="docutils literal notranslate"><span class="pre">ElectricityPole</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Furnace"><code class="docutils literal notranslate"><span class="pre">Furnace</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.ElectricFurnace"><code class="docutils literal notranslate"><span class="pre">ElectricFurnace</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Chest"><code class="docutils literal notranslate"><span class="pre">Chest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.StorageTank"><code class="docutils literal notranslate"><span class="pre">StorageTank</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.RocketSilo"><code class="docutils literal notranslate"><span class="pre">RocketSilo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Rocket"><code class="docutils literal notranslate"><span class="pre">Rocket</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Lab"><code class="docutils literal notranslate"><span class="pre">Lab</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Pipe"><code class="docutils literal notranslate"><span class="pre">Pipe</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.Reactor"><code class="docutils literal notranslate"><span class="pre">Reactor</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.EntityGroup"><code class="docutils literal notranslate"><span class="pre">EntityGroup</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.WallGroup"><code class="docutils literal notranslate"><span class="pre">WallGroup</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.BeltGroup"><code class="docutils literal notranslate"><span class="pre">BeltGroup</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.PipeGroup"><code class="docutils literal notranslate"><span class="pre">PipeGroup</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.entities.ElectricityGroup"><code class="docutils literal notranslate"><span class="pre">ElectricityGroup</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.game_types.ResourceName"><code class="docutils literal notranslate"><span class="pre">ResourceName</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.game_types.PrototypeMetaclass"><code class="docutils literal notranslate"><span class="pre">PrototypeMetaclass</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.game_types.RecipeName"><code class="docutils literal notranslate"><span class="pre">RecipeName</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.game_types.Prototype"><code class="docutils literal notranslate"><span class="pre">Prototype</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.game_types.Technology"><code class="docutils literal notranslate"><span class="pre">Technology</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.game_types.Resource"><code class="docutils literal notranslate"><span class="pre">Resource</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/modules.html#module-fle.env.gym_env.action">Gym Environment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.gym_env.action.Action"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.gym_env.observation.GameInfo"><code class="docutils literal notranslate"><span class="pre">GameInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.gym_env.observation.AgentMessage"><code class="docutils literal notranslate"><span class="pre">AgentMessage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.gym_env.observation.TaskInfo"><code class="docutils literal notranslate"><span class="pre">TaskInfo</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.env.gym_env.observation.Observation"><code class="docutils literal notranslate"><span class="pre">Observation</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/modules.html#module-fle.agents.agent_abc">Agents</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.agents.agent_abc.AgentABC"><code class="docutils literal notranslate"><span class="pre">AgentABC</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.agents.agent_abc.create_default_agent_card"><code class="docutils literal notranslate"><span class="pre">create_default_agent_card()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.agents.models.TaskResponse"><code class="docutils literal notranslate"><span class="pre">TaskResponse</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.agents.models.Response"><code class="docutils literal notranslate"><span class="pre">Response</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.agents.models.CompletionReason"><code class="docutils literal notranslate"><span class="pre">CompletionReason</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.agents.models.CompletionResult"><code class="docutils literal notranslate"><span class="pre">CompletionResult</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.agents.gym_agent.GymAgent"><code class="docutils literal notranslate"><span class="pre">GymAgent</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/modules.html#module-fle.eval.tasks.task_abc">Evaluation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.eval.tasks.task_abc.TaskABC"><code class="docutils literal notranslate"><span class="pre">TaskABC</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.eval.algorithms.independent.ValueCalculator"><code class="docutils literal notranslate"><span class="pre">ValueCalculator</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.eval.algorithms.independent.Recipe"><code class="docutils literal notranslate"><span class="pre">Recipe</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/modules.html#module-fle.commons.db_client">Commons</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.commons.db_client.get_postgres_exceptions"><code class="docutils literal notranslate"><span class="pre">get_postgres_exceptions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.commons.db_client.get_sqlite_exceptions"><code class="docutils literal notranslate"><span class="pre">get_sqlite_exceptions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.commons.db_client.DBClient"><code class="docutils literal notranslate"><span class="pre">DBClient</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.commons.db_client.PostgresDBClient"><code class="docutils literal notranslate"><span class="pre">PostgresDBClient</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.commons.db_client.SQLliteDBClient"><code class="docutils literal notranslate"><span class="pre">SQLliteDBClient</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.commons.db_client.create_default_sqlite_db"><code class="docutils literal notranslate"><span class="pre">create_default_sqlite_db()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.commons.db_client.create_default_postgres_db"><code class="docutils literal notranslate"><span class="pre">create_default_postgres_db()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.commons.db_client.create_db_client"><code class="docutils literal notranslate"><span class="pre">create_db_client()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/modules.html#fle.commons.db_client.get_next_version"><code class="docutils literal notranslate"><span class="pre">get_next_version()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/modules.html#module-fle.cluster.config">Cluster</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/modules.html#tool-documentation">Tool Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/modules.html#module-index">Module Index</a><ul class="simple">
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html#indices-and-tables">Indices and tables</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Factorio Learning Environment</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fle.commons.db_client</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for fle.commons.db_client</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statistics</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">tenacity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tenacity</span><span class="w"> </span><span class="kn">import</span> <span class="n">retry_if_exception_type</span><span class="p">,</span> <span class="n">wait_exponential</span><span class="p">,</span> <span class="n">wait_random_exponential</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fle.commons.models.conversation</span><span class="w"> </span><span class="kn">import</span> <span class="n">Conversation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fle.commons.models.game_state</span><span class="w"> </span><span class="kn">import</span> <span class="n">GameState</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fle.commons.models.program</span><span class="w"> </span><span class="kn">import</span> <span class="n">Program</span>


<span class="c1"># Optional PostgreSQL imports</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">psycopg2</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">psycopg2.extras</span><span class="w"> </span><span class="kn">import</span> <span class="n">DictCursor</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">psycopg2.pool</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadedConnectionPool</span>

    <span class="n">PSYCOPG2_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">psycopg2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">DictCursor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ThreadedConnectionPool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">PSYCOPG2_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Configure logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="get_postgres_exceptions">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.get_postgres_exceptions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_postgres_exceptions</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get PostgreSQL exception classes if available, otherwise return empty tuple&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">PSYCOPG2_AVAILABLE</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">psycopg2</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span>
            <span class="n">psycopg2</span><span class="o">.</span><span class="n">InterfaceError</span><span class="p">,</span>
            <span class="n">psycopg2</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">()</span></div>



<div class="viewcode-block" id="get_sqlite_exceptions">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.get_sqlite_exceptions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_sqlite_exceptions</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get SQLite exception classes&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">InterfaceError</span><span class="p">,</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">)</span></div>



<div class="viewcode-block" id="DBClient">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DBClient</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<div class="viewcode-block" id="DBClient.__init__">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">max_conversation_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">min_connections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">max_connections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="o">**</span><span class="n">db_config</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_conversation_length</span> <span class="o">=</span> <span class="n">max_conversation_length</span>
        <span class="c1"># Don&#39;t store connection as instance variable</span>
        <span class="c1"># Instead create connection pool</span>
        <span class="c1"># self.pool = []</span>
        <span class="c1"># self.max_pool_size = 5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_connections</span> <span class="o">=</span> <span class="n">min_connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_connections</span> <span class="o">=</span> <span class="n">max_connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_config</span> <span class="o">=</span> <span class="n">db_config</span></div>


<div class="viewcode-block" id="DBClient.initialize">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.initialize">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the connection pool&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="DBClient.get_connection">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.get_connection">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Regular context manager for database connections&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="DBClient.get_beam_heads">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.get_beam_heads">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_beam_heads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">beam_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Program</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the highest value programs across all depths for a given version.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">DictCursor</span><span class="p">)</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="c1"># Use a CTE to get diverse set of programs</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        WITH ProgramsByDepth AS (</span>
<span class="sd">                            SELECT DISTINCT ON (depth) *</span>
<span class="sd">                            FROM programs</span>
<span class="sd">                            WHERE version = %s</span>
<span class="sd">                            AND state_json IS NOT NULL</span>
<span class="sd">                            AND value IS NOT NULL</span>
<span class="sd">                            ORDER BY depth, value DESC</span>
<span class="sd">                        )</span>
<span class="sd">                        SELECT * FROM (</span>
<span class="sd">                            SELECT * FROM ProgramsByDepth</span>
<span class="sd">                            ORDER BY value DESC</span>
<span class="sd">                            LIMIT %s</span>
<span class="sd">                        ) as depth_diverse</span>
<span class="sd">                        UNION DISTINCT</span>
<span class="sd">                        SELECT * FROM (</span>
<span class="sd">                            SELECT * FROM programs</span>
<span class="sd">                            WHERE version = %s</span>
<span class="sd">                            AND state_json IS NOT NULL</span>
<span class="sd">                            AND value IS NOT NULL</span>
<span class="sd">                            ORDER BY value DESC</span>
<span class="sd">                            LIMIT %s</span>
<span class="sd">                        ) as value_focused</span>
<span class="sd">                        ORDER BY value DESC</span>
<span class="sd">                        LIMIT %s</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">beam_width</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">beam_width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">beam_width</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="n">results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No programs found for version </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">[]</span>

                    <span class="n">programs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Program</span><span class="o">.</span><span class="n">from_row</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
                    <span class="n">depths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">depth</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">programs</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">programs</span><span class="p">)</span><span class="si">}</span><span class="s2"> beam heads for version </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">depths</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">programs</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching beam heads: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="DBClient.version_exists">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.version_exists">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">version_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a version exists in the database&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        SELECT EXISTS(</span>
<span class="sd">                            SELECT 1 FROM programs WHERE version = %s</span>
<span class="sd">                        )</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">version</span><span class="p">,),</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking version existence: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="DBClient.get_version_metadata">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.get_version_metadata">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_version_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get metadata for a specific version&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">DictCursor</span><span class="p">)</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        SELECT DISTINCT version_description, model</span>
<span class="sd">                        FROM programs </span>
<span class="sd">                        WHERE version = %s</span>
<span class="sd">                        LIMIT 1</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">version</span><span class="p">,),</span>
                    <span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching version metadata: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="DBClient.create_program">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.create_program">[docs]</a>
    <span class="nd">@tenacity</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span>
        <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">get_postgres_exceptions</span><span class="p">()),</span>
        <span class="n">wait</span><span class="o">=</span><span class="n">wait_random_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_program</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">:</span> <span class="n">Program</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Program</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new program, now with connection management&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        INSERT INTO programs (code, value, visits, parent_id, state_json, conversation_json, </span>
<span class="sd">                                           completion_token_usage, prompt_token_usage, token_usage, response, </span>
<span class="sd">                                           holdout_value, raw_reward, version, version_description, model, meta, </span>
<span class="sd">                                           achievements_json, instance, depth, advantage, ticks, timing_metrics_json)</span>
<span class="sd">                        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)</span>
<span class="sd">                        RETURNING id, created_at</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="mi">0</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_raw</span><span class="p">()</span> <span class="k">if</span> <span class="n">program</span><span class="o">.</span><span class="n">state</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">program</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">dict</span><span class="p">()),</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">completion_token_usage</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">prompt_token_usage</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">token_usage</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">holdout_value</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">raw_reward</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">version_description</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">program</span><span class="o">.</span><span class="n">meta</span><span class="p">),</span>
                            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">program</span><span class="o">.</span><span class="n">achievements</span><span class="p">),</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">depth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">advantage</span><span class="p">,</span>
                            <span class="n">program</span><span class="o">.</span><span class="n">ticks</span><span class="p">,</span>
                            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">program</span><span class="o">.</span><span class="n">timing_metrics</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">program</span><span class="o">.</span><span class="n">timing_metrics</span>
                            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                    <span class="nb">id</span><span class="p">,</span> <span class="n">created_at</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="n">program</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
                    <span class="n">program</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">created_at</span>
                    <span class="k">return</span> <span class="n">program</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="DBClient.cleanup">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.cleanup">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up database resources&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">closeall</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing connection pool: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DBClient.get_all_program_rewards">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.get_all_program_rewards">[docs]</a>
    <span class="nd">@tenacity</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span>
        <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">get_postgres_exceptions</span><span class="p">()),</span>
        <span class="n">wait</span><span class="o">=</span><span class="n">wait_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_all_program_rewards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all program rewards with proper connection management&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT value </span>
<span class="s2">            FROM programs </span>
<span class="s2">            WHERE value IS NOT NULL</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; AND version = </span><span class="si">%s</span><span class="s2">&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span><span class="p">,)</span> <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">params</span><span class="p">)</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching program rewards: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="DBClient.get_largest_version">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.get_largest_version">[docs]</a>
    <span class="nd">@tenacity</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span>
        <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">get_postgres_exceptions</span><span class="p">()),</span>
        <span class="n">wait</span><span class="o">=</span><span class="n">wait_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_largest_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT MAX(version)</span>
<span class="s2">            FROM programs</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching largest version: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="DBClient.get_largest_depth_in_version">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.get_largest_depth_in_version">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_largest_depth_in_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT MAX(depth)</span>
<span class="s2">                    FROM programs</span>
<span class="s2">                    WHERE version = </span><span class="si">{</span><span class="n">version</span><span class="si">}</span>
<span class="s2">                &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching largest depth: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="DBClient.execute_query">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.execute_query">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a query and return results as list of dictionaries&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">DictCursor</span><span class="p">)</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing query: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="DBClient.sample_parent">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.sample_parent">[docs]</a>
    <span class="nd">@tenacity</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span>
        <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">get_postgres_exceptions</span><span class="p">()),</span>
        <span class="n">wait</span><span class="o">=</span><span class="n">wait_random_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">sample_parent</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">compression_strength</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">adaptive_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Program</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample parent with proper connection management and adjusted reward scaling.</span>

<span class="sd">        Args:</span>
<span class="sd">            version: The version of programs to sample from</span>
<span class="sd">            compression_strength: Fixed compression strength between 0 and 1.</span>
<span class="sd">                                If None, uses adaptive compression. Higher values mean more exploitation. Lower means more exploration.</span>
<span class="sd">            adaptive_period: Number of steps for a full sine wave cycle when using</span>
<span class="sd">                            adaptive compression.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">DictCursor</span><span class="p">)</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="c1"># First get the current step count for adaptive compression</span>
                    <span class="k">if</span> <span class="n">compression_strength</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;SELECT COUNT(*) as step_count FROM programs WHERE version = </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">step_count</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="s2">&quot;step_count&quot;</span><span class="p">]</span>
                        <span class="c1"># Calculate adaptive compression using sine wave</span>
                        <span class="c1"># sin goes from -1 to 1, so we transform to 0 to 1</span>
                        <span class="n">compression_strength</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">step_count</span> <span class="o">/</span> <span class="n">adaptive_period</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        WITH recent AS (</span>
<span class="sd">                            SELECT id, value, conversation_json</span>
<span class="sd">                            FROM programs</span>
<span class="sd">                            WHERE version = %s </span>
<span class="sd">                            AND advantage IS NOT NULL</span>
<span class="sd">                            -- AND jsonb_array_length(conversation_json-&gt;&#39;messages&#39;) &lt; %s</span>
<span class="sd">                            ORDER BY created_at DESC</span>
<span class="sd">                            LIMIT 300</span>
<span class="sd">                        )</span>
<span class="sd">                        SELECT id, advantage </span>
<span class="sd">                        FROM recent</span>
<span class="sd">                        &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">version</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="n">results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>

                    <span class="c1"># Get statistics of the value distribution</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;advantage&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
                    <span class="n">mean_value</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">std_value</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">1.0</span>

                    <span class="c1"># Apply reward transformation to handle power-law distribution</span>
                    <span class="k">def</span><span class="w"> </span><span class="nf">transform_reward</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="c1"># Z-score normalization</span>
                        <span class="n">z_score</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">mean_value</span><span class="p">)</span> <span class="o">/</span> <span class="n">std_value</span> <span class="k">if</span> <span class="n">std_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>

                        <span class="c1"># Compress extreme values using tanh with current compression strength</span>
                        <span class="n">compressed</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">z_score</span> <span class="o">*</span> <span class="n">compression_strength</span><span class="p">)</span>

                        <span class="c1"># Scale back to positive values and add small epsilon</span>
                        <span class="k">return</span> <span class="p">(</span><span class="n">compressed</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="mf">1e-6</span>

                    <span class="c1"># Log current compression state</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Using compression strength: </span><span class="si">{</span><span class="n">compression_strength</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;adaptive&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">compression_strength</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;fixed&#39;</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>

                    <span class="c1"># Calculate transformed weights</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">transform_reward</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;advantage&quot;</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span>
                    <span class="p">]</span>

                    <span class="c1"># Normalize weights</span>
                    <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">total_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sampled_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">normalized_weights</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="n">total_weight</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span>
                        <span class="p">]</span>
                        <span class="n">sampled_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span>
                            <span class="p">[</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">normalized_weights</span><span class="p">],</span>
                            <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">normalized_weights</span><span class="p">],</span>
                            <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Fetch the selected program</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        SELECT * FROM programs WHERE id = %s</span>
<span class="sd">                        &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">sampled_id</span><span class="p">,),</span>
                    <span class="p">)</span>

                    <span class="n">row</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">Program</span><span class="o">.</span><span class="n">from_row</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="k">if</span> <span class="n">row</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sampling parent: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="DBClient.update_program">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.update_program">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_program</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">updates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Program</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update program with proper connection management&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="c1"># Handle timing_metrics separately since it needs to be JSON serialized</span>
                    <span class="n">timing_metrics</span> <span class="o">=</span> <span class="n">updates</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;timing_metrics&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">timing_metrics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;timing_metrics_json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">timing_metrics</span><span class="p">)</span>

                    <span class="n">set_clauses</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = %s&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">updates</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">updates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        UPDATE programs</span>
<span class="s2">                        SET </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">set_clauses</span><span class="p">)</span><span class="si">}</span>
<span class="s2">                        WHERE id = %s</span>
<span class="s2">                        RETURNING *</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="n">values</span> <span class="o">+</span> <span class="p">[</span><span class="n">program_id</span><span class="p">],</span>
                    <span class="p">)</span>

                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">Program</span><span class="o">.</span><span class="n">from_row</span><span class="p">(</span>
                        <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">description</span><span class="p">],</span> <span class="n">row</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="DBClient.get_resume_state">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.DBClient.get_resume_state">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_resume_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">resume_version</span><span class="p">,</span> <span class="n">process_id</span><span class="p">,</span> <span class="n">agent_idx</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="n">Optional</span><span class="p">[</span><span class="n">GameState</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Conversation</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the state to resume from&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get most recent successful program to resume from</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM programs </span>
<span class="s2">            WHERE version = </span><span class="si">%s</span>
<span class="s2">            AND state_json IS NOT NULL</span>
<span class="s2">            AND value IS NOT NULL</span>
<span class="s2">            -- AND meta-&gt;&gt;&#39;process_id&#39; = </span><span class="si">%s</span><span class="s2">::text</span>
<span class="s2">            AND instance = </span><span class="si">%s</span>
<span class="s2">            ORDER BY created_at DESC</span>
<span class="s2">            LIMIT 1</span>
<span class="s2">            &quot;&quot;&quot;</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">resume_version</span><span class="p">,</span> <span class="n">process_id</span><span class="p">,</span> <span class="n">agent_idx</span><span class="p">))</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid programs found for version </span><span class="si">{</span><span class="n">resume_version</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="c1"># Choose a program to resume from</span>
            <span class="n">program</span> <span class="o">=</span> <span class="n">Program</span><span class="o">.</span><span class="n">from_row</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">description</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">program</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">program</span><span class="o">.</span><span class="n">conversation</span><span class="p">,</span> <span class="n">program</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">program</span><span class="o">.</span><span class="n">depth</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting resume state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="PostgresDBClient">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.PostgresDBClient">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PostgresDBClient</span><span class="p">(</span><span class="n">DBClient</span><span class="p">):</span>
<div class="viewcode-block" id="PostgresDBClient.__init__">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.PostgresDBClient.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">max_conversation_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">min_connections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">max_connections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="o">**</span><span class="n">db_config</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PSYCOPG2_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;PostgreSQL support requires psycopg2. Install it with: pip install &#39;factorio-learning-environment[psql]&#39; &quot;</span>
                <span class="s2">&quot;or set FLE_DB_TYPE=sqlite in your .env file to use SQLite instead.&quot;</span>
            <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">max_conversation_length</span><span class="p">,</span> <span class="n">min_connections</span><span class="p">,</span> <span class="n">max_connections</span><span class="p">,</span> <span class="o">**</span><span class="n">db_config</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PostgresDBClient.initialize">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.PostgresDBClient.initialize">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the connection pool&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Double check pattern</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="n">ThreadedConnectionPool</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">min_connections</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_connections</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">db_config</span>
                    <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure connection pool exists with proper locking&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="n">ThreadedConnectionPool</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">min_connections</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_connections</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">db_config</span>
                    <span class="p">)</span>

<div class="viewcode-block" id="PostgresDBClient.get_connection">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.PostgresDBClient.get_connection">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Regular context manager for database connections&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_pool</span><span class="p">()</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">getconn</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">conn</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">putconn</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error returning connection to pool: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">putconn</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="SQLliteDBClient">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.SQLliteDBClient">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SQLliteDBClient</span><span class="p">(</span><span class="n">DBClient</span><span class="p">):</span>
<div class="viewcode-block" id="SQLliteDBClient.__init__">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.SQLliteDBClient.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">max_conversation_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">min_connections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">max_connections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="o">**</span><span class="n">db_config</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">max_conversation_length</span><span class="p">,</span> <span class="n">min_connections</span><span class="p">,</span> <span class="n">max_connections</span><span class="p">,</span> <span class="o">**</span><span class="n">db_config</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;database_file&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLliteDBClient.initialize">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.SQLliteDBClient.initialize">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the connection pool&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Double check pattern</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="n">ThreadedConnectionPool</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">min_connections</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_connections</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">db_config</span>
                    <span class="p">)</span></div>


<div class="viewcode-block" id="SQLliteDBClient.get_connection">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.SQLliteDBClient.get_connection">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager for SQLite database connections&quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database_file</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">conn</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="SQLliteDBClient.get_largest_version">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.SQLliteDBClient.get_largest_version">[docs]</a>
    <span class="nd">@tenacity</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span>
        <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">get_sqlite_exceptions</span><span class="p">()),</span>
        <span class="n">wait</span><span class="o">=</span><span class="n">wait_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_largest_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT MAX(version)</span>
<span class="s2">            FROM programs</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching largest version: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="SQLliteDBClient.get_resume_state">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.SQLliteDBClient.get_resume_state">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_resume_state</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">resume_version</span><span class="p">,</span> <span class="n">process_id</span><span class="p">,</span> <span class="n">agent_idx</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="n">Optional</span><span class="p">[</span><span class="n">GameState</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Conversation</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the state to resume from&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get most recent successful program to resume from</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT * FROM programs </span>
<span class="s2">            WHERE version = ?</span>
<span class="s2">            AND state_json IS NOT NULL</span>
<span class="s2">            AND value IS NOT NULL</span>
<span class="s2">            AND json_extract(meta, &#39;$.process_id&#39;) = ?</span>
<span class="s2">            AND instance = ?</span>
<span class="s2">            ORDER BY created_at DESC</span>
<span class="s2">            LIMIT 1</span>
<span class="s2">            &quot;&quot;&quot;</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">resume_version</span><span class="p">,</span> <span class="n">process_id</span><span class="p">,</span> <span class="n">agent_idx</span><span class="p">))</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid programs found for version </span><span class="si">{</span><span class="n">resume_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">resulting_program_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">([</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">description</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="c1"># make meta, state_json achievements_json and conversation_json table a dict</span>
            <span class="n">resulting_program_dict</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resulting_program_dict</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">])</span>
            <span class="n">resulting_program_dict</span><span class="p">[</span><span class="s2">&quot;achievements_json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">resulting_program_dict</span><span class="p">[</span><span class="s2">&quot;achievements_json&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">resulting_program_dict</span><span class="p">[</span><span class="s2">&quot;conversation_json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">resulting_program_dict</span><span class="p">[</span><span class="s2">&quot;conversation_json&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">resulting_program_dict</span><span class="p">[</span><span class="s2">&quot;state_json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">resulting_program_dict</span><span class="p">[</span><span class="s2">&quot;state_json&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># Choose a program to resume from</span>
            <span class="n">program</span> <span class="o">=</span> <span class="n">Program</span><span class="o">.</span><span class="n">from_row</span><span class="p">(</span><span class="n">resulting_program_dict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">program</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">program</span><span class="o">.</span><span class="n">conversation</span><span class="p">,</span> <span class="n">program</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">program</span><span class="o">.</span><span class="n">depth</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting resume state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="SQLliteDBClient.create_program">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.SQLliteDBClient.create_program">[docs]</a>
    <span class="nd">@tenacity</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span>
        <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">get_sqlite_exceptions</span><span class="p">()),</span>
        <span class="n">wait</span><span class="o">=</span><span class="n">wait_random_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_program</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">:</span> <span class="n">Program</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Program</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new program, now with connection management&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

                <span class="c1"># Insert the program data</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    INSERT INTO programs (code, value, visits, parent_id, state_json, conversation_json, </span>
<span class="sd">                                          completion_token_usage, prompt_token_usage, token_usage, response, </span>
<span class="sd">                                          holdout_value, raw_reward, version, version_description, model, meta, </span>
<span class="sd">                                          achievements_json, instance, depth, advantage, ticks, timing_metrics_json)</span>
<span class="sd">                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Assuming visits is initially set to 0</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">to_raw</span><span class="p">()</span> <span class="k">if</span> <span class="n">program</span><span class="o">.</span><span class="n">state</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">program</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">dict</span><span class="p">()),</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">completion_token_usage</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">prompt_token_usage</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">token_usage</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">response</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">holdout_value</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">raw_reward</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">version_description</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">program</span><span class="o">.</span><span class="n">meta</span><span class="p">),</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">program</span><span class="o">.</span><span class="n">achievements</span><span class="p">),</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">depth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">advantage</span><span class="p">,</span>
                        <span class="n">program</span><span class="o">.</span><span class="n">ticks</span><span class="p">,</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">program</span><span class="o">.</span><span class="n">timing_metrics</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">program</span><span class="o">.</span><span class="n">timing_metrics</span>
                        <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>

                <span class="c1"># Get the last inserted row ID</span>
                <span class="n">program</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">lastrowid</span>

                <span class="c1"># Retrieve the created_at timestamp</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT created_at FROM programs WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">program</span><span class="o">.</span><span class="n">id</span><span class="p">,)</span>
                <span class="p">)</span>
                <span class="n">program</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="c1"># Return the updated program object</span>
                <span class="k">return</span> <span class="n">program</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating program: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="SQLliteDBClient.execute_query">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.SQLliteDBClient.execute_query">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a query and return results as list of dictionaries (SQLite version)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>  <span class="c1"># Enable dict-like access</span>
                <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing query: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span></div>
</div>



<div class="viewcode-block" id="create_default_sqlite_db">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.create_default_sqlite_db">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_default_sqlite_db</span><span class="p">(</span><span class="n">db_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create SQLite database with required schema if it doesn&#39;t exist&quot;&quot;&quot;</span>
    <span class="n">db_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>

    <span class="c1"># Create directory if it doesn&#39;t exist</span>
    <span class="n">db_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create database and table if they don&#39;t exist</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Check if programs table exists</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT name FROM sqlite_master </span>
<span class="s2">            WHERE type=&#39;table&#39; AND name=&#39;programs&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating SQLite database schema in </span><span class="si">{</span><span class="n">db_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE TABLE programs (</span>
<span class="s2">                    id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s2">                    code TEXT NOT NULL,</span>
<span class="s2">                    value REAL DEFAULT 0.0,</span>
<span class="s2">                    visits INTEGER DEFAULT 0,</span>
<span class="s2">                    parent_id INTEGER,</span>
<span class="s2">                    state_json TEXT,</span>
<span class="s2">                    conversation_json TEXT NOT NULL,</span>
<span class="s2">                    completion_token_usage INTEGER,</span>
<span class="s2">                    prompt_token_usage INTEGER,</span>
<span class="s2">                    token_usage INTEGER,</span>
<span class="s2">                    response TEXT,</span>
<span class="s2">                    holdout_value REAL,</span>
<span class="s2">                    raw_reward REAL,</span>
<span class="s2">                    version INTEGER DEFAULT 1,</span>
<span class="s2">                    version_description TEXT DEFAULT &#39;&#39;,</span>
<span class="s2">                    model TEXT DEFAULT &#39;gpt-4o&#39;,</span>
<span class="s2">                    meta TEXT,</span>
<span class="s2">                    achievements_json TEXT,</span>
<span class="s2">                    instance INTEGER DEFAULT -1,</span>
<span class="s2">                    depth REAL DEFAULT 0.0,</span>
<span class="s2">                    advantage REAL DEFAULT 0.0,</span>
<span class="s2">                    ticks INTEGER DEFAULT 0,</span>
<span class="s2">                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">                    timing_metrics_json TEXT</span>
<span class="s2">                )</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SQLite database schema created successfully!&quot;</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="create_default_postgres_db">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.create_default_postgres_db">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_default_postgres_db</span><span class="p">(</span><span class="o">**</span><span class="n">db_config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create PostgreSQL database with required schema if it doesn&#39;t exist&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">db_config</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Check if programs table exists</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT EXISTS (</span>
<span class="s2">                SELECT FROM information_schema.tables </span>
<span class="s2">                WHERE table_schema = &#39;public&#39; </span>
<span class="s2">                AND table_name = &#39;programs&#39;</span>
<span class="s2">            )</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>

        <span class="n">table_exists</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">table_exists</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating PostgreSQL database schema&quot;</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE TABLE programs (</span>
<span class="s2">                    id SERIAL PRIMARY KEY,</span>
<span class="s2">                    code TEXT NOT NULL,</span>
<span class="s2">                    value REAL DEFAULT 0.0,</span>
<span class="s2">                    visits INTEGER DEFAULT 0,</span>
<span class="s2">                    parent_id INTEGER,</span>
<span class="s2">                    state_json TEXT,</span>
<span class="s2">                    conversation_json TEXT NOT NULL,</span>
<span class="s2">                    completion_token_usage INTEGER,</span>
<span class="s2">                    prompt_token_usage INTEGER,</span>
<span class="s2">                    token_usage INTEGER,</span>
<span class="s2">                    response TEXT,</span>
<span class="s2">                    holdout_value REAL,</span>
<span class="s2">                    raw_reward REAL,</span>
<span class="s2">                    version INTEGER DEFAULT 1,</span>
<span class="s2">                    version_description TEXT DEFAULT &#39;&#39;,</span>
<span class="s2">                    model TEXT DEFAULT &#39;gpt-4o&#39;,</span>
<span class="s2">                    meta TEXT,</span>
<span class="s2">                    achievements_json TEXT,</span>
<span class="s2">                    instance INTEGER DEFAULT -1,</span>
<span class="s2">                    depth REAL DEFAULT 0.0,</span>
<span class="s2">                    advantage REAL DEFAULT 0.0,</span>
<span class="s2">                    ticks INTEGER DEFAULT 0,</span>
<span class="s2">                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">                    timing_metrics_json TEXT</span>
<span class="s2">                )</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PostgreSQL database schema created successfully!&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating PostgreSQL schema: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="create_db_client">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.create_db_client">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_db_client</span><span class="p">(</span>
    <span class="n">max_conversation_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
    <span class="n">min_connections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">max_connections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DBClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create database client based on environment configuration.</span>
<span class="sd">    Defaults to SQLite with automatic setup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check for database type preference</span>
    <span class="n">db_type</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;FLE_DB_TYPE&quot;</span><span class="p">,</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">db_type</span> <span class="o">==</span> <span class="s2">&quot;postgres&quot;</span><span class="p">:</span>
        <span class="c1"># Check if psycopg2 is available</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PSYCOPG2_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;PostgreSQL support requires psycopg2. Install it with: pip install &#39;factorio-learning-environment[psql]&#39; &quot;</span>
                <span class="s2">&quot;or set FLE_DB_TYPE=sqlite in your .env file to use SQLite instead.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Use PostgreSQL if explicitly requested and configured</span>
        <span class="n">required_vars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;SKILLS_DB_HOST&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SKILLS_DB_PORT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SKILLS_DB_NAME&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SKILLS_DB_USER&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SKILLS_DB_PASSWORD&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">missing_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">required_vars</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">missing_vars</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: PostgreSQL requested but missing environment variables: </span><span class="si">{</span><span class="n">missing_vars</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Falling back to SQLite...&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing environment variables: </span><span class="si">{</span><span class="n">missing_vars</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">db_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SKILLS_DB_HOST&quot;</span><span class="p">),</span>
            <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SKILLS_DB_PORT&quot;</span><span class="p">),</span>
            <span class="s2">&quot;dbname&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SKILLS_DB_NAME&quot;</span><span class="p">),</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SKILLS_DB_USER&quot;</span><span class="p">),</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SKILLS_DB_PASSWORD&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">create_default_postgres_db</span><span class="p">(</span><span class="o">**</span><span class="n">db_config</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PostgresDBClient</span><span class="p">(</span>
            <span class="n">max_conversation_length</span><span class="o">=</span><span class="n">max_conversation_length</span><span class="p">,</span>
            <span class="n">min_connections</span><span class="o">=</span><span class="n">min_connections</span><span class="p">,</span>
            <span class="n">max_connections</span><span class="o">=</span><span class="n">max_connections</span><span class="p">,</span>
            <span class="o">**</span><span class="n">db_config</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">db_type</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="c1"># Default to SQLite</span>
        <span class="n">sqlite_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SQLITE_DB_FILE&quot;</span><span class="p">,</span> <span class="s2">&quot;.fle/data.db&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using SQLite database file: </span><span class="si">{</span><span class="n">sqlite_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Auto-create SQLite database if it doesn&#39;t exist</span>
        <span class="n">create_default_sqlite_db</span><span class="p">(</span><span class="n">sqlite_file</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SQLliteDBClient</span><span class="p">(</span>
            <span class="n">max_conversation_length</span><span class="o">=</span><span class="n">max_conversation_length</span><span class="p">,</span>
            <span class="n">min_connections</span><span class="o">=</span><span class="n">min_connections</span><span class="p">,</span>
            <span class="n">max_connections</span><span class="o">=</span><span class="n">max_connections</span><span class="p">,</span>
            <span class="n">database_file</span><span class="o">=</span><span class="n">sqlite_file</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid database type: </span><span class="si">{</span><span class="n">db_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_next_version">
<a class="viewcode-back" href="../../../api/modules.html#fle.commons.db_client.get_next_version">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_next_version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get next available version number&quot;&quot;&quot;</span>
    <span class="n">db_client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_db_client</span><span class="p">()</span>
    <span class="n">version</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db_client</span><span class="o">.</span><span class="n">get_largest_version</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">db_client</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">version</span> <span class="o">+</span> <span class="mi">1</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, FLE Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>